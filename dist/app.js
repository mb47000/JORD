let route,currentPage,dbReady=new CustomEvent("dbReady",{bubbles:!0}),pageReady=new CustomEvent("pageReady",{bubbles:!0}),pageChange=new CustomEvent("pageChange",{bubbles:!0}),initWebsite=new CustomEvent("initWebsite",{bubbles:!0}),routeList=[],routes={};function loadProducts(){fetch("/api/get?name=products").then(e=>e.json()).then(e=>{e.forEach(e=>{let t={slug:e.slug,fileName:"assets/views/templates/product.html",title:e.name,access:e.access};routeList.push(t)}),Object.assign(routes,routeList),document.dispatchEvent(dbReady),localStorage.setItem("products",JSON.stringify(e))})}fetch("/api/get?name=pages").then(e=>e.json()).then(e=>{e.forEach(e=>{let t={slug:e.slug,fileName:"assets/views/pages/"+e.fileName+".html",title:e.title,access:e.access};routeList.push(t)}),Object.assign(routes,routeList),loadProducts()});class Router{constructor(e){this.routes=e,this.cache={},window.addEventListener("hashchange",this.loadPage.bind(this,"hashchange")),document.addEventListener("dbReady",this.loadPage.bind(this,"dbReady"))}async loadPage(e,t){if(route=location.hash||"#",currentPage=await Object.values(this.routes).find(e=>route==="#"+e.slug),void 0===currentPage)route="#404",currentPage=Object.values(this.routes).find(e=>"#"+e.slug=="#404"),n.bind(this)();else if("1"===currentPage.access){let e=localStorage.getItem("userLocal");if(null!=e){e=JSON.parse(e);let t=e.token;(()=>{fetch(`/api/token?token=${t}&action=verify`).then(e=>e.json()).then(e=>{1!=e?(route="#401",currentPage=Object.values(this.routes).find(e=>"#"+e.slug=="#401"),n.bind(this)(),localStorage.removeItem("userLocal")):n.bind(this)()})})()}else route="#401",currentPage=Object.values(this.routes).find(e=>"#"+e.slug=="#401"),n.bind(this)()}else n.bind(this)();async function n(){if(!this.cache.hasOwnProperty(route)){let e=await fetch(currentPage.fileName);this.cache[route]=await e.text()}let e=route.replace("#","/");history.replaceState(this.cache[route],null,e),document.getElementById("content").innerHTML=this.cache[route],document.querySelector("title").innerHTML=currentPage.title,"dbReady"===t.type&&document.dispatchEvent(pageReady)}}}let currentPageAccess,pagesRoutes=new Router(routes);window.onpopstate=e=>{document.getElementById("content").innerHTML=pagesRoutes.cache[document.location.pathname.replace("/","#")],setTimeout(()=>{document.dispatchEvent(pageChange)},200)},document.addEventListener("pageReady",e=>{buildProduct(),productsPage(),document.dispatchEvent(initWebsite)}),window.addEventListener("pageChange",e=>{buildProduct(),productsPage()});let productPrice,userMenuHTML,loginLogoutFormHTML,cartHTML,cartRowHTML,userProfilHTML,productsOptionsHTML,productCardHTML,cartLocal,optionsList={};function buildProduct(){let e=location.pathname.split("/").pop(),t=localStorage.getItem("products");JSON.parse(t).forEach(t=>{t.slug===e&&(document.querySelector("h1").innerHTML=t.name,document.getElementById("ref").innerHTML=t.ref,document.getElementById("price").innerHTML=productPrice=t.price,t.options?(Object.values(t.options).forEach(e=>{const t=e.values;if("checkbox"===e.type){let n=document.createElement("div");n.innerHTML=productsOptionsHTML,n.innerHTML=n.querySelector("#checkbox").innerHTML,n.querySelector(".title").innerHTML=e.name;let o=n.querySelector(".checkboxGroup").innerHTML;n.querySelector(".checkboxGroup").innerHTML="",t.forEach(e=>{optionsList[e.ref]=e.price;let t=document.createElement("div");t.innerHTML=o;let r=t.querySelector("input"),a=t.querySelector("label");r.id=r.value=e.ref,a.setAttribute("for",e.ref),a.innerHTML=e.name,n.querySelector(".checkboxGroup").innerHTML=n.querySelector(".checkboxGroup").innerHTML.concat(t.innerHTML)}),document.getElementById("options").innerHTML=document.getElementById("options").innerHTML.concat(n.innerHTML)}else if("select"===e.type){let n=document.createElement("div");n.innerHTML=productsOptionsHTML,n.innerHTML=n.querySelector("#select").innerHTML,n.querySelector(".title").innerHTML=e.name;let o=n.querySelector(".selectGroup").innerHTML;n.querySelector(".selectGroup").id=e.ref,t.forEach(e=>{optionsList[e.ref]=e.price;let t=document.createElement("div");t.innerHTML=o,t.querySelector("option").id=t.querySelector("option").value=e.ref,t.querySelector("option").innerHTML=e.name,n.querySelector(".selectGroup").innerHTML=n.querySelector(".selectGroup").innerHTML.concat(t.innerHTML)}),document.getElementById("options").innerHTML=document.getElementById("options").innerHTML.concat(n.innerHTML)}}),document.getElementById("options").addEventListener("click",e=>e.target.classList.contains("optProduct")?calcProductPrice():null)):document.getElementById("options").remove())})}function calcProductPrice(){let e=parseFloat(productPrice);document.getElementById("options").querySelectorAll(".optProduct").forEach(t=>{!0!==t.selected&&!0!==t.checked||""===t.value||(e+=parseFloat(optionsList[t.id]))}),document.getElementById("price").innerHTML=e.toFixed(2)}function productsPage(e="all",t=-1){let n=document.getElementById("productsPage");if(n){let o=JSON.parse(localStorage.getItem("products")),r=1;o.forEach(o=>{let a;if(("all"!==e&&o.category===e||"all"===e)&&(a=o),a&&(r<=t||-1===t)){r++;let e=document.createElement("span");e.innerHTML=productCardHTML,e.querySelector(".productCard").href="#"+a.slug,e.querySelector(".productImg").src=a.images[0],e.querySelector(".productName").innerHTML=a.name,e.querySelector(".productPrice").innerHTML=a.price,n.querySelector(".productsList").insertAdjacentHTML("beforeend",e.innerHTML)}})}}function showPushNotification(e,t){const n=document.getElementById("pushNotification").firstElementChild;switch(n.classList.remove("show"),n.classList.add("hide"),n.classList.remove("info"),n.classList.remove("success"),n.classList.remove("error"),e){case"success":n.classList.add("success");break;case"error":n.classList.add("error");break;case"info":n.classList.add("info")}n.querySelector(".msg").innerText="",n.querySelector(".msg").innerText=t,n.classList.toggle("hide"),n.classList.toggle("show"),setTimeout((function(){n.classList.contains("show")&&(n.classList.toggle("show"),n.classList.toggle("hide"))}),5e3)}function showModal(e){document.querySelectorAll("[data-modal]").forEach(e=>e.hidden=!0),document.querySelector(`[data-modal=${e}]`).hidden=!1}function hideModal(){document.querySelectorAll("[data-modal]").forEach(e=>e.hidden=!0)}function refreshCart(){cartLocal=localStorage.getItem("cartLocal")?localStorage.getItem("cartLocal"):cartLocal=null;const e=document.getElementById("buttonCart");document.querySelectorAll(".cart").forEach(t=>{const n=t.getElementsByTagName("tbody")[0];n.innerHTML="";let o=0;e.classList.add("tooltip"),e.classList.remove("buttonModal"),e.removeAttribute("data-modaltarget"),null!=cartLocal&&(e.classList.remove("tooltip"),e.classList.add("buttonModal"),e.dataset.modaltarget="cart",JSON.parse(cartLocal).forEach(e=>{if(n.innerHTML+=cartRowHTML,n.lastElementChild.querySelector(".refLabel > .value").innerHTML=e.ref,n.lastElementChild.querySelector(".productLabel > .value").innerHTML=e.name,n.lastElementChild.querySelector(".priceLabel > .value").innerHTML=e.price,n.lastElementChild.querySelector(".qtyLabel > .value").innerHTML=e.qty,n.lastElementChild.querySelector(".totalLabel > .value").innerHTML=(e.price*e.qty).toFixed(2),e.options.length>0){let t=document.createElement("div");t.innerHTML=e.options,t.classList.add("optionsList"),n.lastElementChild.querySelector(".refLabel > .value").after(t)}o+=e.price*e.qty}),n.nextElementSibling.lastElementChild.querySelector(".value").innerHTML=o.toFixed(2))}),localStorage.getItem("userLocal")&&saveCart(),refreshCounter()}function addCart(e){const t=e.closest(".productElem");let n={},o=[],r=[];if(t.children.options&&t.children.options.querySelectorAll(".optProduct").forEach(async e=>{!0!==e.selected&&!0!==e.checked||""===e.value||await r.push(e.id)}),n={ref:t.children.ref.innerHTML,name:t.children.name.innerHTML,price:parseFloat(t.children.price.innerHTML),qty:parseFloat(t.children.qty.children.qtyInput.value),options:r},cartLocal){o=JSON.parse(localStorage.getItem("cartLocal"));let e=!0;o.forEach(async t=>{n.ref===t.ref&&String(n.options)===String(t.options)&&(t.qty+=n.qty,e=!1)}),e?(o.push(n),localStorage.setItem("cartLocal",JSON.stringify(o))):localStorage.setItem("cartLocal",JSON.stringify(o)),refreshCart()}else o.push(n),localStorage.setItem("cartLocal",JSON.stringify(o)),refreshCart()}function removeCart(e,t){let n=[];JSON.parse(cartLocal).forEach(o=>o.ref===e&&String(o.options)===t?null:n.push(o)),n.length<=0?(localStorage.removeItem("cartLocal"),refreshCart(),hideModal()):(localStorage.setItem("cartLocal",JSON.stringify(n)),refreshCart())}function refreshCounter(){let e=document.getElementById("cartProductNumber"),t=document.getElementById("cartModal");e&&(e.innerHTML=t.querySelectorAll(".productLabel").length)}function plusMinusProduct(e,t){let n=e.parentElement.querySelector(".refLabel").firstElementChild.innerHTML,o="plus"===t?parseInt(e.querySelector(".value").innerHTML)+1:parseInt(e.querySelector(".value").innerHTML)-1;0===o&&(o=1),e.querySelector(".value").innerHTML=o,cartLocal=JSON.parse(localStorage.getItem("cartLocal")),cartLocal.forEach(e=>e.ref===n?e.qty=o:null),localStorage.setItem("cartLocal",JSON.stringify(cartLocal)),refreshCart()}function saveCart(){let e=localStorage.getItem("cartLocal")?localStorage.getItem("cartLocal"):"null",t=JSON.parse(localStorage.getItem("userLocal"));fetch(`/api/cart?token=${t.token}&email=${t.email}&action=saveCart`,{method:"POST",headers:{"Content-type":"application/json"},body:e})}function getCart(){let e=localStorage.getItem("cartLocal")?localStorage.getItem("cartLocal"):{},t=JSON.parse(localStorage.getItem("userLocal"));fetch(`/api/cart?token=${t.token}&email=${t.email}&action=getCart`,{method:"POST",headers:{"Content-type":"application/json"},body:e}).then(e=>e.json()).then(e=>{!1===e?showPushNotification("error","Session expirée"):"null"!=e&&localStorage.setItem("cartLocal",e)}).then(()=>refreshCart())}function getUserProfilPage(e){writeData();let t=JSON.parse(localStorage.getItem("userLocal"));e.addEventListener("click",e=>{if(e.target.classList.contains("editProfil")){let t=e.target.closest(".section").nextElementSibling,n=t.querySelectorAll("input"),o=t.querySelectorAll(".labelSpan"),r=t.querySelector(".buttonSection");n.forEach(e=>{e.hidden=!1}),o.forEach(e=>{e.hidden=!0}),r.hidden=!1}if(e.target.closest(".saveProfil")){let e={email:t.email,firstname:document.getElementById("firstnameField").nextElementSibling.value,lastname:document.getElementById("lastnameField").nextElementSibling.value,address:document.getElementById("addressField").nextElementSibling.value,postalCode:document.getElementById("postalcodeField").nextElementSibling.value,town:document.getElementById("townField").nextElementSibling.value,shipping_address:document.getElementById("addressShippingField").nextElementSibling.value,shipping_postalCode:document.getElementById("postalcodeShippingField").nextElementSibling.value,shipping_town:document.getElementById("townShippingField").nextElementSibling.value};fetch("/api/updateUser?token="+t.token,{method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{!1===e?showPushNotification("error","Session expirée"):(localStorage.setItem("userLocal",JSON.stringify(e)),showPushNotification("success","Informations sauvegardées"),writeData(),cancelEdit())})}if(e.target.classList.contains("editPassword")){let e=document.getElementById("newPassword").value,t=document.getElementById("confirmPassword").value,n=document.getElementById("oldPassword").value,o=document.getElementById("emailField").innerHTML;/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9!@#$%^&*()_+\-=]*.{8,25}$/.test(e)?e===t?fetch(`/api/updatePwd?email=${o}&password=${n}&newPassword=${e}`).then(e=>e.json()).then(e=>{"user not found"===e?showPushNotification("error","Email incorrect"):"incorrect password"===e?showPushNotification("error","Mauvais mot de passe"):"password updated"===e&&(showPushNotification("success","Modification du mot de passe réussi"),document.getElementById("newPassword").value="",document.getElementById("confirmPassword").value="",document.getElementById("oldPassword").value="",cancelEdit())}):showPushNotification("error","Le nouveau mot de passe n'est pas identique à la confirmation"):showPushNotification("error","Le mot de passe doit contenir 8 à 25 caractères et au moins 1 majuscule, 1 minuscule et 1 chiffre.")}e.target.classList.contains("cancelSave")&&cancelEdit()})}function cancelEdit(){let e=document.querySelectorAll("input"),t=document.querySelectorAll(".labelSpan"),n=document.querySelectorAll(".buttonSection");e.forEach(e=>{e.hidden=!0}),t.forEach(e=>{e.hidden=!1}),n.forEach(e=>{e.hidden=!0})}function writeData(){let e=localStorage.getItem("userLocal");e=JSON.parse(e),document.getElementById("emailField").innerHTML=e.email,document.getElementById("firstnameField").innerHTML=document.getElementById("firstnameField").nextElementSibling.value=e.firstname,document.getElementById("lastnameField").innerHTML=document.getElementById("lastnameField").nextElementSibling.value=e.lastname,document.getElementById("addressField").innerHTML=document.getElementById("addressField").nextElementSibling.value=e.address,document.getElementById("postalcodeField").innerHTML=document.getElementById("postalcodeField").nextElementSibling.value=e.postalCode,document.getElementById("townField").innerHTML=document.getElementById("townField").nextElementSibling.value=e.town,document.getElementById("addressShippingField").innerHTML=document.getElementById("addressShippingField").nextElementSibling.value=e.shipping_address,document.getElementById("postalcodeShippingField").innerHTML=document.getElementById("postalcodeShippingField").nextElementSibling.value=e.shipping_postalCode,document.getElementById("townShippingField").innerHTML=document.getElementById("townShippingField").nextElementSibling.value=e.shipping_town}function userIsLog(){localStorage.getItem("cartLocal")?refreshCart():getCart(),document.getElementById("loginRegister").innerHTML=userMenuHTML,document.getElementById("logoutMenu").addEventListener("click",e=>{e.preventDefault(),localStorage.removeItem("userLocal"),userIsNotLog(),showPushNotification("success","Déconnection réussi !"),document.dispatchEvent(dbReady)})}function userIsNotLog(){document.getElementById("loginRegister").innerHTML=loginLogoutFormHTML,localStorage.removeItem("cartLocal"),refreshCart()}function loginRegister(e){document.querySelectorAll(".loginRegisterForm").forEach(t=>{let n=t.querySelector(".switchForm"),o=t.querySelector(".buttonSend");n.addEventListener("click",e=>{e.preventDefault(),o.classList.contains("loginSubmit")?(n.innerHTML="J'ai déjà un compte",t.querySelector("legend").innerHTML="S'enregistrer",t.confirmPassword.hidden=!1,o.value="Inscription",o.classList.toggle("loginSubmit")):(n.innerHTML="Pas encore enregistré",t.querySelector("legend").innerHTML="S'identifier",t.confirmPassword.hidden=!0,o.value="Connexion",o.classList.toggle("loginSubmit"))}),t&&t.addEventListener("submit",async t=>{t.preventDefault();let n="?";if(""===t.target.monprenom.value&"ceci est mon adresse"===t.target.monadresse.value){let s=new FormData(t.target);if(o.classList.contains("loginSubmit")){for(var[r,a]of s.entries())n=n.concat(`${r}=${a}&`);n=n.slice(0,-1),fetch("/api/login"+n).then(e=>e.json()).then(t=>{"user not found"===t?showPushNotification("error","Email incorrect"):"incorrect password"===t?showPushNotification("error","Mauvais mot de passe"):(localStorage.setItem("userLocal",JSON.stringify(t)),showPushNotification("success","Connexion réussi !"),"modal"===e?hideModal():purchase("step2"),userIsLog())})}else{let e={};for(var[r,a]of s.entries())e[r]=a,n=n.concat(`${r}=${a}&`);const t=/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9!@#$%^&*()_+\-=]*.{8,25}$/.test(e.password);!t&&showPushNotification("error","Le mot de passe doit contenir 8 à 25 caractères et au moins 1 majuscule, 1 minuscule et 1 chiffre."),t&&e.password===e.confirmPassword&&(n=n.slice(0,-1),fetch("/api/register"+n).then(e=>e.json()).then(e=>{"email already use"===e?showPushNotification("error","Adresse email déjà utilisée"):(showPushNotification("success","Compte créé, vous pouvez vous connecter"),hideModal())}))}}})})}function purchase(e){let t,n=document.getElementById("purchase").querySelector(".content");if("step1"===e)n.innerHTML=cartHTML,t=n.querySelector(".purchaseButton"),t.firstElementChild.innerHTML="Continuer ma commande",t.href="#commander?etape=2",refreshCart();else if("step2"===e)n.innerHTML=userProfilHTML,t=n.querySelector(".purchaseButton"),t.hidden=!1,t.firstElementChild.innerHTML="Finaliser ma commande",t.href="#commander?etape=3",n.querySelector(".editPassword").style.display="none",getUserProfilPage(n);else if("step3"===e){let e=document.querySelectorAll(".labelSpan");t=n.querySelector(".purchaseButton");const o=e=>e>0;let r=[];e.forEach(e=>{r.push(e.innerHTML.length)}),r.every(o)?createOrders():showPushNotification("error","Veuillez remplir tous les champs")}else"step4"===e&&console.log("add payment api");t&&t.addEventListener("click",e=>{e.preventDefault(),localStorage.getItem("userLocal")?("#commander?etape=2"===e.target.closest(".purchaseButton").hash&&purchase("step2"),"#commander?etape=3"===e.target.closest(".purchaseButton").hash&&purchase("step3")):(n.innerHTML=loginLogoutFormHTML,loginRegister("purchase"))})}function createOrders(){let e=JSON.parse(localStorage.getItem("userLocal")),t=e.email,n=e.token;fetch(`/api/orders?token=${n}&email=${t}&action=createOrders`).then(e=>e.json()).then(e=>{"order created"===e?purchase("step4"):showPushNotification("error","Une erreur est survenue, merci de contacter l'adminitrateur")})}fetch("../assets/views/parts/navbar.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>document.getElementById("navbar").innerHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/footer.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>document.getElementById("footer").innerHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/pushNotification.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>document.getElementById("pushNotification").innerHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/userMenu.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>userMenuHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/loginLogoutForm.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>loginLogoutFormHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/cart.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>cartHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/cartRow.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>cartRowHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/userProfil.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>userProfilHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/productsOptions.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>productsOptionsHTML=e).catch(e=>console.error(e)),fetch("../assets/views/parts/productCard.html",{mode:"no-cors"}).then(e=>e.text()).then(e=>productCardHTML=e).catch(e=>console.error(e)),document.addEventListener("initWebsite",(function(){const e=document.getElementById("pushNotification").firstElementChild;e.lastElementChild.addEventListener("click",t=>{e.classList.toggle("show"),e.classList.toggle("hide")})})),document.body.addEventListener("click",e=>{null!=e.target.dataset.modaltarget?showModal(e.target.dataset.modaltarget):null===e.target.closest(".modal")&&hideModal()}),window.addEventListener("hashchange",hideModal),document.addEventListener("initWebsite",()=>{document.getElementById("addCart")&&document.getElementById("addCart").addEventListener("click",e=>addCart(e.target)),document.getElementById("cartModal").innerHTML=cartHTML}),document.addEventListener("pageChange",()=>{document.getElementById("addCart")&&document.getElementById("addCart").addEventListener("click",e=>addCart(e.target))}),document.body.addEventListener("click",e=>{if(e.target.closest(".removeCart")){removeCart(e.target.closest(".removeCart").parentElement.parentElement.parentElement.querySelector(".refLabel > .value").innerHTML,e.target.closest(".removeCart").parentElement.parentElement.parentElement.querySelector(".refLabel > .optionsList")?e.target.closest(".removeCart").parentElement.parentElement.parentElement.querySelector(".refLabel > .optionsList").innerHTML:"")}e.target.closest(".plusProduct")&&plusMinusProduct(e.target.closest(".plusProduct").closest(".qtyLabel"),"plus"),e.target.closest(".minusProduct")&&plusMinusProduct(e.target.closest(".minusProduct").closest(".qtyLabel"),"minus")}),document.addEventListener("initWebsite",(function(){localStorage.getItem("userLocal")?userIsLog():(document.getElementById("loginRegister").innerHTML=loginLogoutFormHTML,loginRegister("modal"),localStorage.getItem("cartLocal")&&refreshCart()),document.querySelectorAll(".accountUserPage").forEach(e=>{e.innerHTML=userProfilHTML,getUserProfilPage(document.getElementById("accountUserPage"))})})),document.addEventListener("pageChange",()=>{document.querySelectorAll(".accountUserPage").forEach(e=>{e.innerHTML=userProfilHTML,getUserProfilPage(document.getElementById("accountUserPage"))})}),document.addEventListener("initWebsite",()=>{document.getElementById("purchase")&&purchase("step1")}),document.addEventListener("pageChange",()=>{document.getElementById("purchase")&&purchase("step1")}),console.log(" hello jord ");